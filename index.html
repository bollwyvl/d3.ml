<!doctype html>
<html>
  <head>
    <script src="//cdn.jsdelivr.net/g/d3js">
      </script>
    <script src="js/d3.template.js"></script>
    
    <script src="//cdnjs.cloudflare.com/ajax/libs/js-yaml/3.2.7/js-yaml.min.js">
      </script>
    
    <script src="//cdnjs.cloudflare.com/ajax/libs/codemirror/5.0.0/codemirror.js">
      </script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/codemirror/5.0.0/mode/yaml/yaml.js">
      </script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/codemirror/5.0.0/addon/fold/foldcode.js">
      </script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/codemirror/5.0.0/addon/fold/foldgutter.js">
      </script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/codemirror/5.0.0/addon/fold/indent-fold.js">
      </script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/codemirror/5.0.0/addon/fold/comment-fold.js">
      </script>
    <!--style>
      @import "bower_components/materialize/dist/css/materialize.min.css";
    </style-->
    <link type="text/css" rel="stylesheet" href='http://cdn.rawgit.com/primer/primer/master/css/primer.css'>
    <link type="text/css" rel="stylesheet" href='http://cdn.  rawgit.com/github/octicons/master/octicons/octicons.css'>
    <style>
      @import "https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.0.0/codemirror.min.css";
      @import "https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.0.0/theme/blackboard.css";
      @import "https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.0.0/addon/fold/foldgutter.css";
    </style>
    <style>
      .btn-group#controller{
        margin: 20px;
        position: fixed;
        right: 0;
        bottom: 0;
        opacity: .6;
        z-index: 1000;
      }
      #menu-modal{}
      #assets-modal{}
      #newtemp-modal{}
      #editor-modal{}
      #modal{
        display: none;
        position: fixed;
        left: 0;
        right: 0;
        background-color: white;
        padding: 0;
        max-height: 70%;
        width: 55%;
        margin: auto;
        overflow-y: auto;
        z-index: 1000;
        -webkit-border-radius: 2px;
        -moz-border-radius: 2px;
        border-radius: 2px;
        background-clip: padding-box;
        opacity: .9;
      }
      .modal .modal-body {
        display: 'block';
        border: 24px;
      }
      #editor-block{
        position: fixed;
        left: 0;
        right: 0;
        top: 40px;
        bottom: 20px;
        margin: auto;
        width: 60%;
        padding: 0;
        border-radius: 2px;
        background-clip: padding-box;
        opacity: .25;
        height: 100%;
        z-index: 600;
      }
      /**
      .CodeMirror {
        height: auto;
      }
      **/
    </style>
  </head>
  <body>
    <script id="initial" type="text/yaml">display:
- child:  
  - append: $div.container
  - append: h1
  - text: d3.template playground
- child:  
  - append: $div.container
  - append: $div.blankslate
  - child:
    - append: h2
    - html: '<code>d3.template</code> is an extension of the powerful <a href="d3js.org">d3js</a> library.'     
  - child: 
    - template: :d3.templates.text
  - child:
    - append: $div.container
    - child:
      - append: $h3
      - html: "<a href='http://primercss.io/'>Github Primer</a> stylesheets are already available to simplify styling."

text:
- append: $div.container
- append: $p.lead
- text: Start typing in the editor to modify this webpage in real-time using d3-like syntaxes.
</script>

    <div id="controller" class="btn-group">
      <button id="menu-trigger" class="btn modal-trigger" type="button">
          <!-- change type and view -->
          <span class="mega-octicon octicon-three-bars"></span>
      </button>
      <!--
      <button id="asset-trigger" class="btn modal-trigger" type="button">
          <span class="mega-octicon octicon-graph"></span>
      </button>

      <button id="template-trigger" class="btn modal-trigger" type="button">
          <span class="mega-octicon octicon-link-external"></span>
      </button>

      <button id="editor-trigger" class="btn" type="button">
          <span class="mega-octicon octicon-pencil"></span>
      </button>
      -->
      
    </div>
    <div id="modal" class="modal container clearfix">
      <div class="modal-body">
        <h2>d3.template playground</h2>
        <ul class="filter-list"></ul>
      </div>  
    </div>
    
    
    <div id="editor-block">
      <a class='hider'>close</a>
      <div id="editor-text"></div>
    </div>
    <div id="preview-block"></div>
    
    
    <script>
      ;( function(){
        nav = d3.select('nav')
          .style('pos ition','fixed')
          .style('width', function(){
            return this.offsetWidth*1.7+'px';
          })
          .style('left', function(){
            return -1 * this.offsetWidth + 'px'
          })
        
        d3.select('body')
          .append('div')
          .style('left','0px')
          .style('top','0px')
          .style('position','fixed')
          .style('height','100%')
          .style('width','60px')
          .on( 'mouseenter', function(e){
            nav.style('left', function(){
              return 0 + 'px'
            })
          })
          .on( 'mousemove', function(e){
            nav.style('left', -1*d3.event.pageX+'px')
          })
          .on( 'mouseleave', function(e){
            nav.style('left', function(){
              return -1 * this.offsetWidth + 'px'
            })
          })
        
        d3.select('#editor-block')
          .on('click',function(){
            
            if (d3.select(this).style('opacity') != '.75'){
              d3.select(this).style('opacity','.75')
            }
          });
        
        modal = d3.select('#modal');
        
        d3.text( 'ui.yml', function(_d){
          
          _d = jsyaml.load( _d );
          
          d3.selectAll('.modal-trigger')
            .on( 'click', function(d){
                var id = d3.select(this).attr('id').split('-')[0];

              var dat = _d[id];
              if (modal.style('display') == 'none'){
                modal.style('display','block')
                     .datum({
                        id: id,
                      });
                UpdateModal(dat);
              } else if (modal.datum() && modal.datum()['id'] && id != modal.datum()['id'] ){
                  modal.datum({
                    id: id,
                  });
                  UpdateModal(dat);
              } else {
                modal.style('display','none')
              }
            })
        })
        function UpdateModal(dat){
          modal.select('ul.filter-list')
            .selectAll('li')
            .data(dat)
            .call( function(s){
               s.enter()
                .append('li')
                .append('a')
                .classed('filter-item',true)
                .attr('href','#')
               
               s.exit()
                .remove();
            })
            .each( function(s){
               d3.select(this)
                .select('a.filter-item')     
                .attr('id',function(d){return d.id;})     
                /**.on('click',function(){
                 
                  modal.style('display','none') 
                  
                })**/
                .text( function(d){
                  return d.name;
                })
            })        

          d3.select('#editor-trigger')
            .on('click',function(d){
              modal.style('display','none');
              d3.select('#editor-block')
                .style('display','block');              
            });

          d3.select('#html-trigger')
            .on('click',function(d){
              var p = d3.select('#preview-block');
              if (p.datum()['state']!='html'){
                p.datum( function(d){
                  d['state'] = 'html'
                  return d
                })
                update();
              }
            });

          d3.select('#raw-trigger')
            .on('click',function(d){
              var p = d3.select('#preview-block');
              if (p.datum()['state']!='raw'){
                p.datum( function(d){
                  d['state'] = 'raw'
                  return d
                })
                update();
              }
            });

          

        }
        editor = CodeMirror(d3.select('#editor-text').node(), {
              theme: "blackboard",
              mode: "yaml",
              lineNumbers: true,
              lineWrapping: true,
              extraKeys: {"Ctrl-Q": function(cm){ cm.foldCode(cm.getCursor()); }},
              foldGutter: {
                rangeFinder: new CodeMirror.fold.combine(CodeMirror.fold.indent, CodeMirror.fold.comment)
              },
              gutters: ["CodeMirror-linenumbers", "CodeMirror-foldgutter"]
            });
        
        editor.setValue(d3.select('#initial').html())
        editor.on('change', update);
        preview = d3.select('#preview-block');
        preview.datum({
          state: 'html'
        })
        function update(){
          d3.select('#preview-block').call( function(s){
            if( s.datum()['state'] == 'html' ){
              s.html('')
               .template(  
                jsyaml.load( editor.getValue() ), function(d){ return d.display } 
              )
            } else if ( s.datum()['state'] == 'raw' ){
              
              s.text( function(){
                return this.innerHTML
              })
            }
          });
        }
        
        d3.select('.hider')
          .on('click', function(d){
            d3.select(this.parentNode)
              .style('display','none')
          })

        update();
      })();
    </script>
  </body>
</html>